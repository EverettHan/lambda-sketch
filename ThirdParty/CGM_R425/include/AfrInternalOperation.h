//===================================================================
// COPYRIGHT Dassault Systemes 2015/06/10
//===================================================================
// AfrInternalOperation.cpp
// Header definition of class AfrInternalOperation
//===================================================================
//
// Usage notes: Specific call for Afr 3DCS specific Operation the client side can call
//
//===================================================================
//  2015/06/10 Creation: Code generated by the 3DS wizard
//===================================================================

#ifndef AfrInternalOperation_H
#define AfrInternalOperation_H

#include "AfrComputeServer.h"
#include "AfrComputeServerUtilities.h"

#include "CATBaseUnknown.h" //pour hresult en attedant

#include "CATUnicodeString.h"

//CSI communication objects
#include "CSIParameters.h"
#include "CSICommands.h"
#include "CSIChannel.h"
#include "CSINode.h"
#include "CSICommandInterface.h"


#define AfrDefaultDomain "Afr"
#define AfrOperationDomain "AfrOperation"
#define AfrAppDomain "AfrApp"

//-----------------------------------------------------------------------
class ExportedByAfrComputeServer AfrInternalOperation : public CSI::CommandInterface {
  
  public:

    // Standard constructors and destructors
    // -------------------------------------
    AfrInternalOperation (const CATUnicodeString& iOperationId, CSI::Node& iNode);
    virtual ~AfrInternalOperation ();

    virtual HRESULT OnBegin     (const CSI::Parameters& parameters, CSI::Channel& origin) {return S_OK;}
    virtual HRESULT OnCommand   (const CSI::Parameters& parameters, CSI::Channel& origin) {return S_OK;}
    virtual HRESULT OnEnd       (const CSI::Parameters& parameters, CSI::Channel& origin) {return S_OK;}
    HRESULT OnDisconnect();
    
    CATUnicodeString GetOperationId() const;
    /**
    * Return true if the request related to the current Channel has been interrupted
    */
    bool IsInterrupted();
    void setChannel(CSI::Channel& origin);
	void resetChannel();
    HRESULT GetCredentials(EK::Credentials& credentials);

    HRESULT SendIntermediateAnswer();

  protected:
    CSI::Parameters GetEmptyOutputs();
    void            Answer(CSI::Channel& origin, int AfrRetCode, CSI::Parameters& undoSyncOutputs, int OperationInputMsg = EXECUTE_OPERATION);
    void            AnswerWithoutNotification(CSI::Channel& origin, int AfrRetCode, CSI::Parameters& undoSyncOutputs);
    void            ReturnOperationExecutionError(CSI::Channel& origin, const CATUnicodeString& errorDesc, int AfrRetCode = UNDO_TRANSACTION_ERROR);
    void            AddAnswerDomain(CSI::Parameters& outputs, CATUnicodeString domain = AfrDefaultDomain);
    CATBoolean      isDeconnected() const;

    std::vector<CATUnicodeString> _errorMessages;
    
    //To remove when JUZ applicative migration done 
    void            setIterativeOperation(CATBoolean iIsIterative);

    void    AnswerProgress();


  private:

    void            SendAnswerMsgNotification(int OperationInputMsg, int isIterativeOperation);

    // Copy constructor and equal operator
    // -----------------------------------
    AfrInternalOperation (AfrInternalOperation &);
    AfrInternalOperation& operator=(AfrInternalOperation&);
       
    CATBoolean       _deconnected;
    CATBoolean       _isIterativeOperation;

    CATUnicodeString _operationId;
    CSI::Node&       _node;
    CSI::Message     _message;
    // Current channel
    CSI::Channel *   _origin;

public:

  virtual int GetViewOptions(const int & iOperationInputMsg) { return 0; };
};

//-----------------------------------------------------------------------

#endif
