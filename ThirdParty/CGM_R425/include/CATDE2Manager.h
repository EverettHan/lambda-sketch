//===================================================================

//===================================================================
// CATDE2Manager.cpp
// Header definition of class CATDE2Manager
//===================================================================
//
// Usage notes:
//
//===================================================================
//  2013-02-12 Creation by Q62: Code generated by the 3DS wizard
//===================================================================

#ifndef CATDE2Manager_H
#define CATDE2Manager_H

#include "CATSYPHashMap.h"

#include "CATDialogEngine.h"
#include "CATDiaAction.h"
#include "CATStateCommand.h"
#include "CATBaseUnknown_var.h"
#include "CATUnicodeString.h"
#include "CATListOfCATUnicodeString.h"
#include "CATListOfCATDialogTransition.h"
#include "CATDE2Utilities.h"				//DE2 bitfields, enum, etc.
#include "CATDialogEngineServices.h"

//For introsspection
class CATSYPStyleProcessor;
class CATSYPMetaClass;

// Graph building methods inputs/outputs
class CATDE2BaseElement;
class CATDE2State;
class CATDialogAgent;
class CATDialogTransition;
class CATAcquisitionFilter;
class CATStateCommand;
class CATDE2BaseTarget;
class CATDE2Action;
class CATDE2EnterStateAction;
class CATDE2LeaveStateAction;
class CATDE2LeaveStateCondition;
class CATDE2Transition;
class CATDE2DialogAgent;
class CATDE2StateCommand;
class CATDE2ReceivedEventCondition;
class CATSYPEvent;
class CATDE2View;
class CATIDE2AbstractView;

class CATCommandGlobalUndo; //To deal with global undo
class CATPathElement;
//-----------------------------------------------------------------------

class ExportedByCATDialogEngine CATDE2Manager: public CATStateCommand
{
  CATDeclareClass;


  public:
    // Standard constructors and destructors
    // -------------------------------------
    CATDE2Manager();
    CATDE2Manager(CATFrmEditor* ipEditor);
    virtual ~CATDE2Manager ();

    // Enables the use of a CATNls resource file with DE   
    // -------------------------------------
    char* GetResourceFilename(int nDepth) const;
    char* GetResourceClass(int nDepth) const;
    int IsOtherResourceFile(int nDepth) const;

    // BuildGraph
    // -------------------------------------
    void	BuildGraph();

    // CATCommand life cycle overwritten methods calls
    // -------------------------------------
    virtual CATStatusChangeRC Activate(CATCommand * iFromClient, CATNotification * iNotification);
    virtual CATStatusChangeRC Desactivate(CATCommand * iFromClient, CATNotification * iNotification);
    virtual CATStatusChangeRC Cancel(CATCommand * iFromClient, CATNotification * iNotification);

  private:
    // Copy constructor and equal operator
    // -----------------------------------
    CATDE2Manager (CATDE2Manager &);
    CATDE2Manager& operator=(CATDE2Manager&);

     //For DE sub command construction
    // -----------------------------------
    CATDE2Manager(const CATUnicodeString& iCmdName, 
                  const CATUnicodeString& iDE2Xml, 
                  const CATUnicodeString& iTargetName, 
                  const CATUnicodeString& iTemplateName);

    //Internal "constructor"    
    void CommonContructor(CATBoolean iNeedToExtractArgs = TRUE);

    
    // Read the Command Header Arguments to find the cmd name and returns it. If not found return "".		
    // -----------------------------------
    CATUnicodeString		ExtractCmdName();

    // Share the views and agents with the user target
    // -------------------------------------
    void	  ShareCommandExecutionContext();
    void	  ShareCommandName(const CATUnicodeString& iCmdName);
    void	  StopSharingCommandExecutionContext();

    // Extract all the command header arguments that can be understound by CATDE2Manager and set them in the right data member...
    // Return S_OK if succeeded and E_FAIL otherwise
    // -----------------------------------
    HRESULT ExtractCmdHdrArgs();
    
    // Methods to build the CATStateCommand corresponding to the Xml DE2 state command
    // -----------------------------------
    CATDE2StateCommand*   BuildStateCommand(CATBaseUnknown* ipCurrentDE2StateCommand, CATStateCommand* iCmd, CATBoolean isBuildingOnlyCommandElements = FALSE);
    HRESULT               BuildView(CATDE2View* ipView);
    CATDialogState*       BuildState(CATDE2State* ipCurrentDE2State, CATBoolean iFistState);
    CATDialogAgent*       BuildAgent(CATBaseUnknown* ipCurrentDE2Agent, CATStateCommand* ipStateCmd = NULL); /*ipStateCmd should be NULL or this in case of setting the current state command properties*/
    CATAcquisitionFilter* BuildFilter(CATBaseUnknown* ipCurrentDE2Filter);
    HRESULT               BuildTransition(CATBaseUnknown* iCurrentStateChild, CATDialogState* ipCurrentState);
    HRESULT               BuildAction(CATDE2Action* iNewDE2ActionToAdd, CATDiaAction** ioCurrentTransactionAction, CATDialogTransition* pCurrentTransition = NULL);
    CATStateCondition*    BuildCondition(CATBaseUnknown* ipCurrentDE2Condition, CATDialogState* ipCurrentState, CATListPV* opNewAgentsCreatedList, CATListOfCATUnicodeString& oTransitionsAgentsList);
    CATStateCondition*    BuildReceivedEventCondition(CATDE2ReceivedEventCondition* ipReceivedCondition, CATDialogState* ipCurrentState, CATListPV* opNewAgentsCreatedList, CATListOfCATUnicodeString& oTransitionsAgentsList);
    CATBoolean            ListenToSenderEventCouple(CATUnicodeString iSenderPath, CATUnicodeString iEventName, CATString iListenningAgentId, CATDialogAgent** ippListenningAgent);
    
    // Methods to set inrospectable properties common to several types
    // -----------------------------------
    HRESULT               SetCommandMode(CATBaseUnknown* ipDE2DialogAgent, CATDialogAgent* ipDialogAgent);

    // Instantiate the user DE Xml target if specified, the CATDE2BaseTarget otherwise
    // -----------------------------------
    void                  InstantiateTarget(CATUnicodeString iDE2TargetFileName);

    // StyleProcessor parsing method
    // -----------------------------------
    CATBaseUnknown_var    ParseDE2Xml(CATUnicodeString iXmlFile = "", CATUnicodeString iTemplateFileName = "");

    // Release hashMaps elements
    // -----------------------------------
    void CleanAgentsHashMap();
    void CleanStatesHashMap();
    void CleanViewsHashMap();
    void CleanActionArgsList();
    void CleanDE2ElementsHashMap();


    // Get the DialogEngineElement from its ID
    // -----------------------------------
    CATDialogState* GetState(const CATUnicodeString& iStateId);

    // Internal: DO NOT USE. Needed for dynamic DE graph building
    // -------------------------------------
    HRESULT    BuildOnlyCommandElements(CATUnicodeString iFatherCmdXml);
    CATBoolean AddDE2State(const CATUnicodeString& iStateName);
    CATBoolean CreateDE2AgentFromDE2(const CATUnicodeString& iAgentID, 
                                     const CATUnicodeString& iDE2AgentType, 
                                     const CATUnicodeString& iCustomType = "", 
                                     const CATUnicodeString& iCustomTypeDll = "",
                                     const CATUnicodeString& iFilterId = "");
   
    //Create Filter that can be added to an agent
    CATBoolean CreateFilterFromDE2(const CATUnicodeString& iFilterId, 
                                   const CATUnicodeString& iFilterMethodName); 

    //Create Filter that can be added to an agent
    CATBoolean CreateCompositeFilterFromDE2(const CATUnicodeString& iFilterId, 
                                            const CATListOfCATUnicodeString& iFiltersNamesList,
                                            CATDE2Utilities::DE2BooleanOperationType iBoleanOp = CATDE2Utilities::UNKNOWN);

    //Create a new transition in the command
    CATBoolean CreateTransitionFromDE2(const CATUnicodeString& iId, 
                                       const CATUnicodeString& iSourceStateID, 
                                       const CATUnicodeString& iTargetStateID, 
                                       const CATUnicodeString& iConditionId, 
                                       const CATUnicodeString& iAction, 
                                       const CATUnicodeString& iUndo = "", 
                                       const CATUnicodeString& iRedo = "");

    CATBoolean CreateTransitionFromDE2(const CATUnicodeString& iId, 
                                       const CATUnicodeString& iSourceStateID, 
                                       const CATUnicodeString& iTargetStateID, 
                                       const CATUnicodeString& iConditionId,
                                       const CATListOfCATUnicodeString& iActionsNamesList); 

    //Create condition that can be added to element of the command
    CATBoolean CreateConditionFromDE2(const CATUnicodeString& iConditionId, 
                                      const CATUnicodeString& iConditionMethodName);

    //Create condition that can be added to element of the command
    CATBoolean CreateConditionFromDE2(const CATUnicodeString& iConditionId, 
                                      const CATUnicodeString& iAgentId, 
                                      CATDE2Utilities::DE2AgentConditionType iType);
    
    //Create condition that can be added to element of the command
    CATBoolean CreateReceivedEventConditionFromDE2(const CATUnicodeString& iConditionId, 
                                                   const CATUnicodeString& iSender, 
                                                   const CATUnicodeString& iEvent,
                                                   CATDE2Utilities::DE2AgentConditionType iConditionType,
                                                   const CATUnicodeString& iAgentId = "");

    //Create condition that can be added to element of the command
    CATBoolean CreateCompositeConditionFromDE2(const CATUnicodeString& iConditionId, 
                                               const CATListOfCATUnicodeString& iConditionsNamesList,
                                               CATDE2Utilities::DE2BooleanOperationType iBoleanOp = CATDE2Utilities::UNKNOWN);
  
    //Add entre/leave state action to a state of the command
    CATBoolean CreateActionFromDE2(const CATUnicodeString& iActionID, const CATUnicodeString& iAction, 
                                                                      const CATUnicodeString& iUndo = "", 
                                                                      const CATUnicodeString& iRedo = "");

    //Add entre/leave state action to a state of the command
    CATBoolean AddStateActionFromDE2(const CATUnicodeString& iStateId, const CATUnicodeString& iAction, 
                                                                       const CATUnicodeString& iUndo = "", 
                                                                       const CATUnicodeString& iRedo = "",
                                                                       CATDE2Utilities::DE2StateActionType iStateActionType = CATDE2Utilities::ENTER);

    CATBoolean AddStateActionFromDE2(const CATUnicodeString& iStateId, const CATUnicodeString& iActionId, CATDE2Utilities::DE2StateActionType iStateActionType);

    //Add leave state condition to a state of the command
    CATBoolean AddStateLeaveConditionFromDE2(const CATUnicodeString& iStateId, 
                                             const CATUnicodeString& iConditionId, 
                                             CATDE2Utilities::DE2BooleanOperationType iBoleanOp = CATDE2Utilities::UNKNOWN);

    //Store DE elements to rebuilt them.
    CATBoolean          StoreDE2Element(CATDE2BaseElement* iElt);
    CATDE2BaseElement*  GetDE2ElementFromID(CATUnicodeString iEltId);

    // Add a callback from the state command
    // -----------------------------------
    CATCallback     AddAnalyseNotificationCBFromDE2Target(CATCommand* iEmetteur, CATNotification* iTypeOfEvent, CATUnicodeString iMethodName);
    CATCallback     AddAnalyseNotificationCBFromDE2Target(CATCommand* iEmetteur, const char * iTypeOfEvent, CATUnicodeString iMethodName);
    
    CATListOfCATUnicodeString	   _CallbackMethodList; //To Store the CB method name

    // Private Data members
    // -----------------------------------
    CATSYPHashMap<CATUnicodeString, CATIDE2AbstractView*> _ViewsAssociativeList;              //Keep the correspondance between views  and their name
    CATSYPHashMap<CATUnicodeString, CATDialogAgent*>      _AgentsAssociativeList;             //Keep the correspondance between agents and their name
    CATSYPHashMap<CATUnicodeString, int>                  _AutoResetAgentsAssociativeList;    //Keep the correspondance between agents auto reset attribute and the agent Id
    CATSYPHashMap<CATUnicodeString, CATDialogState*>      _StatesAssociativeList;             //Keep the correspondance between states and their name

    CATSYPHashMap<CATUnicodeString, CATDE2BaseElement*>   _DE2ElementsAssociativeList;        //Keep the correspondance between DE element and their name

    CATSYPHashMap<CATULONG64, CATListOfCATUnicodeString>  _TransitionsAgentsAssociativeList;  //Keep the correspondance between transtions Address and all the agents Ids which can trigger it by been valuated
    
    //To associate target or source states to te right transition
    CATListOfCATUnicodeString     _TargetForTransitionList;
    CATListOfCATDialogTransition  _TransitionNeedingTargetList;
    CATListOfCATUnicodeString     _InitialStateForTransitionList;
    CATListOfCATDialogTransition  _TransitionNeedingInitialStateList;

    CATListPV                     _pActionArgList;

    CATULONG64                    _LastTransitionExecutedAddress;

    //User files names (DE2 Xml, DE2 xml target, DE2 xml template)
    CATUnicodeString              _CmdName;
    CATUnicodeString              _xmlFile;
    CATUnicodeString              _userTargetName;
    CATUnicodeString              _userTemplateName;
    CATListOfCATUnicodeString     _rscClassesNames; 
    CATListOfCATUnicodeString     _rscFilesNames;

    CATBaseUnknown_var            _spGeneratedObject;
    CATDE2BaseTarget*             _pDE2UserTarget;
    CATSYPMetaClass*              _pTargetMetaClass;
    CATListValCATBaseUnknown_var  _targetInitArgs;

    //Flag to know is first activation or activation after a deactivation
    CATBoolean                     _firstActivate;

    // Methods to link to the transitions in order to execute the User Action methods
    // -----------------------------------
    CATBoolean ExecuteDo          (void* iDE2ActionDo);
    CATBoolean ExecuteBeforeUndo  (void* iDE2ActionUndo);
    CATBoolean ExecuteAfterUndo   (void* iDE2ActionAfterUndo);
    CATBoolean ExecuteBeforeRedo  (void* iDE2ActionRedo);
    CATBoolean ExecuteAfterRedo   (void* iDE2ActionAfterRedo);
    void       ExecuteCB          (CATCommand * , CATNotification *, CATCommandClientData iCallbackname);
    CATBoolean UpdateLastExecutedTransition (void*  iTransAddr);

    // Method to link to the transitions conditions in order to execute the user condition methods
    // -----------------------------------
    CATBoolean CheckCondition(void* iDE2ConditionToCheck);

    // Method to link to the agent user filters in order to apply the user filter methods
    // -----------------------------------
    CATBoolean ApplyFilter(CATDialogAgent * iAgent, void* iDE2FilterToApply);

    // Method to link to the CATDE2EditAgent in order to use the user element provider method
    // -----------------------------------
    CATPathElement* ExecuteElementProvider(CATClassId  id);
    
    CATCommandGlobalUndo* GetGlobalUndo();
    
    //To call a C++ user method (this method must be in the user DE XML target) from its name
    CATBoolean CallCppUserMethodFromName(const CATUnicodeString& iMethodName, CATPathElement** oPathElt = NULL);
    
    // Method to clean the state we're leaving
    // -----------------------------------
    CATBoolean ResetLastTransitionAgents(void* iUselessData = NULL);

    // Error handling methods
    // -----------------------------------
    void DE2TagUnrecognized               (CATBaseUnknown* ipCurrentTag);
    void DE2ChildrenTagBrowsingError      (CATBaseUnknown* ipCurrentParentTag,  CATString iParentId, int iChildNb);
    void DE2ChildrenTagUnknown            (CATBaseUnknown* ipCurrentParentTag, CATString iParentId, CATString iTagId);
    void DE2GivenArgumentIsNULL           (CATString iArgumentNULL, CATString iMethodName="");
    void DE2EventArgumentIsNULL           (CATString iArgumentNULL, CATString iMethodName);
    void DE2BuildingDialogEngineObjectFromTagFailed	(CATString iObject, CATString iTag);
    void DE2ElementIdNotUnique            (CATUnicodeString iId, CATString iMethodName);
     
    
    // Internal: DO NOT USE. => Use in friend classes and methods for test or service 
    // -------------------------------------
    CATDE2BaseTarget* GetTarget();


    friend class CATEditAgent;
    friend class CATDE2Manager; //For DE sub command construction
    friend class CATDE2TargetPrivateImplementation;
    friend class CATFrmEditorCtxMenu_UT;
    friend class CATDE2DumpCppStateCommand;//To DUMP DE view for DE state commant ==> TEST prupose

    friend ExportedByCATDialogEngine CATBoolean IsDefaultSelectionCmd(CATCommand* ipCmd); //Service to known is a command is the default selection command
    
    //Internal tests
    friend class CATDE2CAfrUrlViewer_UTCommandLauncher;
    friend class CATFrmEditorCtxMenu_UT;
};

//-----------------------------------------------------------------------

#endif
 
