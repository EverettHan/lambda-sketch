
// COPYRIGHT Dassault Systemes 0007
//===================================================================
//
// CATCVMSysUndoRedoMemento.h
// Header definition of CATCVMSysUndoRedoMemento
//
//===================================================================
//
// Usage notes:
//
//===================================================================
//
//  July 0007  Creation: Code generated by the CAA wizard  JHI
//===================================================================
#ifndef CATCVMSysUndoRedoMemento_H
#define CATCVMSysUndoRedoMemento_H
//-----------------------------------------------------------------------
#include "CATCVMSysObjects.h"
#include "CATOmbSessionUndoMementoDefs.h"
#include "CATCVMSysUndoRedoMementoFactory.h"
//#include "CATCVMNewArray.h"

#include "CATCVMLog.h"
#include "ListPOfCATCVMSystem.h"
#include "ListPOfCATCVMObject.h"
#include "ListPOfCATCVMContainer.h"
#include "CATListOfInt.h"
#include "CATBoolean.h"

class ExportedByCATCVMSysObjects CATCVMSysUndoRedoMemento : public CATOmbUndoRedoMemento
{
  //------------------------------------------------------------------------------
  // Component declaration for ObjectModeler
  //------------------------------------------------------------------------------
public:
  CATDeclareClass; // ObjectModeler
  // ASE (2008-07-02): l'appli a besoin de pouvoir faire IsAKindOf pour
  //                   ensuite faire le cast et appeler GetLoggedObjects

  //CATCVMNewClassArrayDeclare;

  //------------------------------------------------------------------------------
  // CATCVMSysUndoRedoMemento
  //------------------------------------------------------------------------------
public:
  static CATCVMSysUndoRedoMemento *Create(OmbMementoFlag iFlags, const CATCVMLog *iCVMLog );

  //------------------------------------------------------------------------------
  // Constructor
  //------------------------------------------------------------------------------
protected:
  CATCVMSysUndoRedoMemento(OmbMementoFlag iFlags);
  HRESULT ReleaseData();

public:

  HRESULT Redo(CATOmbSessionUndoContext& ioContext,OmbUndoRedoErrorId& oErrorId);
  HRESULT Undo(CATOmbSessionUndoContext& ioContext,OmbUndoRedoErrorId& oErrorId);
  //------------------------------------------------------------------------------
  // Merge the ioCVMMemento with <this> CVMMemento and delete ioCVMMemento if existing
  // Warning ioCVMMemento contains the latest events and <this> just previous events.
  // Take care and do not reverse the order of the Memento
  // take into account undone state of each memento
  //------------------------------------------------------------------------------
  HRESULT Merge(CATCVMSysUndoRedoMemento * &ioCVMMemento);
  //------------------------------------------------------------------------------
  // Has Memento been used for Undo process
  //------------------------------------------------------------------------------
  CATBoolean IsUndone ();
  //------------------------------------------------------------------------------
  // Get Log for Visu treatment
  //------------------------------------------------------------------------------
  HRESULT GetLoggedCVMObjects (ListPOfCATCVMSystem  & oCVMBodyList,
                               CATListOfInt         & oCVMObjectNumber,
                               ListPOfCATCVMObject  & oCVMObjectList);
                               
  static HRESULT Checkup      (ListPOfCATCVMSystem  & iCVMBodyList,
                               CATListOfInt         & iCVMObjectNumber,
                               ListPOfCATCVMObject  & iCVMObjectList);
  
  //------------------------------------------------------------------------------
  // Internal CVMUsage Only
  //------------------------------------------------------------------------------
  HRESULT RestoreData(CATBoolean UndoRedoAllowed);
  HRESULT ForgetEvents();
  HRESULT GetLoggedCVMObjects (ListPOfCATCVMObject  & oCVMObjectList,
                               CATListOfInt         & oCVMEventType,
                               ListPOfCATCVMObject  & oCVMPhotoList);

private:
  CATCVMSysUndoRedoMemento(OmbMementoFlag iFlags,  const CATCVMLog  *iCVMLog);
  virtual ~CATCVMSysUndoRedoMemento ();
  
  HRESULT Set( const CATCVMLog * iCVMLog);

  HRESULT ReleaseObjects(ListPOfCATCVMSystem & iCVMBodyList, ListPOfCATCVMContainer& iCVMContainerList);
  HRESULT AddRefObjects (ListPOfCATCVMSystem & iCVMBodyList, ListPOfCATCVMContainer& oCVMContainerList);
  HRESULT UpdateDirtyState ();

  CATCVMLog *            _CVMLogForMemento;
  ListPOfCATCVMSystem    _CVMSystemListToRelease;
  ListPOfCATCVMContainer _CVMContainerListToRelease;
  short                  _Undone;
};
#endif

